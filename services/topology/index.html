



<!DOCTYPE html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
        <link rel="canonical" href="https://www.opensciencegrid.org/operations/services/topology/">
      
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../../img/favicon.ico">
      <meta name="generator" content="mkdocs-0.17.5, mkdocs-material-2.9.4">
    
    
      
        <title>Topology Service - OSG Operations</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/application.451f80e5.css">
      
      
    
    
      <script src="../../assets/javascripts/modernizr.1aa3b519.js"></script>
    
    
      <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
      
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../../assets/fonts/material-icons.css">
    
      <link rel="stylesheet" href="../../css/extra.css">
    
    
  </head>
  
    <body dir="ltr">
  
    <svg class="md-svg">
      <defs>
        
        
          <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448"
    viewBox="0 0 416 448" id="__github">
  <path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19-18.125
        8.5-18.125-8.5-10.75-19-3.125-20.5 3.125-20.5 10.75-19 18.125-8.5
        18.125 8.5 10.75 19 3.125 20.5zM320 304q0 10-3.125 20.5t-10.75
        19-18.125 8.5-18.125-8.5-10.75-19-3.125-20.5 3.125-20.5 10.75-19
        18.125-8.5 18.125 8.5 10.75 19 3.125 20.5zM360
        304q0-30-17.25-51t-46.75-21q-10.25 0-48.75 5.25-17.75 2.75-39.25
        2.75t-39.25-2.75q-38-5.25-48.75-5.25-29.5 0-46.75 21t-17.25 51q0 22 8
        38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0
        37.25-1.75t35-7.375 30.5-15 20.25-25.75 8-38.375zM416 260q0 51.75-15.25
        82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5-41.75
        1.125q-19.5 0-35.5-0.75t-36.875-3.125-38.125-7.5-34.25-12.875-30.25-20.25-21.5-28.75q-15.5-30.75-15.5-82.75
        0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25
        30.875q36.75-8.75 77.25-8.75 37 0 70 8 26.25-20.5
        46.75-30.25t47.25-9.75q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34
        99.5z" />
</svg>
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#topology-service" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="https://www.opensciencegrid.org/operations/" title="OSG Operations" class="md-header-nav__button md-logo">
          
            <i class="md-icon"></i>
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            
              <span class="md-header-nav__topic">
                OSG Operations
              </span>
              <span class="md-header-nav__topic">
                Topology Service
              </span>
            
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          
            <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
            
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
          
        
      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            


  


  <a href="https://github.com/opensciencegrid/operations/" title="Go to repository" class="md-source" data-md-source="github">
    
      <div class="md-source__icon">
        <svg viewBox="0 0 24 24" width="24" height="24">
          <use xlink:href="#__github" width="24" height="24"></use>
        </svg>
      </div>
    
    <div class="md-source__repository">
      GitHub
    </div>
  </a>

          </div>
        </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href="https://www.opensciencegrid.org/operations/" title="OSG Operations" class="md-nav__button md-logo">
      
        <i class="md-icon"></i>
      
    </a>
    OSG Operations
  </label>
  
    <div class="md-nav__source">
      


  


  <a href="https://github.com/opensciencegrid/operations/" title="Go to repository" class="md-source" data-md-source="github">
    
      <div class="md-source__icon">
        <svg viewBox="0 0 24 24" width="24" height="24">
          <use xlink:href="#__github" width="24" height="24"></use>
        </svg>
      </div>
    
    <div class="md-source__repository">
      GitHub
    </div>
  </a>

    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../.." title="Home" class="md-nav__link">
      Home
    </a>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2" checked>
    
    <label class="md-nav__link" for="nav-2">
      Services
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-2">
        Services
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../install-gwms-factory/" title="Installing GlideinWMS Factory" class="md-nav__link">
      Installing GlideinWMS Factory
    </a>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Topology Service
      </label>
    
    <a href="./" title="Topology Service" class="md-nav__link md-nav__link--active">
      Topology Service
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#deployment" title="Deployment" class="md-nav__link">
    Deployment
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#installation" title="Installation" class="md-nav__link">
    Installation
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#file-system-locations" title="File system locations" class="md-nav__link">
    File system locations
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#software-configuration" title="Software configuration" class="md-nav__link">
    Software configuration
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#data-configuration" title="Data configuration" class="md-nav__link">
    Data configuration
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#github-configuration-for-webhook-app" title="GitHub Configuration for Webhook App" class="md-nav__link">
    GitHub Configuration for Webhook App
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#required-system-packages" title="Required System Packages" class="md-nav__link">
    Required System Packages
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#testing-changes-on-the-itb-instance" title="Testing changes on the ITB instance" class="md-nav__link">
    Testing changes on the ITB instance
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#reverting-changes" title="Reverting changes" class="md-nav__link">
    Reverting changes
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#updating-the-production-instance" title="Updating the production instance" class="md-nav__link">
    Updating the production instance
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#reverting-changes_1" title="Reverting changes" class="md-nav__link">
    Reverting changes
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../topology-contacts-data/" title="Topology and Contacts Data" class="md-nav__link">
      Topology and Contacts Data
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../finalize-cache-registration/" title="Finalize Cache Registration" class="md-nav__link">
      Finalize Cache Registration
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../sending-announcements/" title="Sending Announcements" class="md-nav__link">
      Sending Announcements
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3">
    
    <label class="md-nav__link" for="nav-3">
      Service Level Agreements
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        Service Level Agreements
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../SLA/collector/" title="HTCondor Collector" class="md-nav__link">
      HTCondor Collector
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../SLA/myosg/" title="MyOSG" class="md-nav__link">
      MyOSG
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../SLA/oasis/" title="OASIS Stratum-0" class="md-nav__link">
      OASIS Stratum-0
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../SLA/oasis-replica/" title="OASIS Replica" class="md-nav__link">
      OASIS Replica
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../SLA/oim/" title="OIM" class="md-nav__link">
      OIM
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../SLA/xdlogin/" title="XDLogin" class="md-nav__link">
      XDLogin
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../external-oasis-repos/" title="External OASIS repositories" class="md-nav__link">
      External OASIS repositories
    </a>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#deployment" title="Deployment" class="md-nav__link">
    Deployment
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#installation" title="Installation" class="md-nav__link">
    Installation
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#file-system-locations" title="File system locations" class="md-nav__link">
    File system locations
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#software-configuration" title="Software configuration" class="md-nav__link">
    Software configuration
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#data-configuration" title="Data configuration" class="md-nav__link">
    Data configuration
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#github-configuration-for-webhook-app" title="GitHub Configuration for Webhook App" class="md-nav__link">
    GitHub Configuration for Webhook App
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#required-system-packages" title="Required System Packages" class="md-nav__link">
    Required System Packages
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#testing-changes-on-the-itb-instance" title="Testing changes on the ITB instance" class="md-nav__link">
    Testing changes on the ITB instance
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#reverting-changes" title="Reverting changes" class="md-nav__link">
    Reverting changes
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#updating-the-production-instance" title="Updating the production instance" class="md-nav__link">
    Updating the production instance
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#reverting-changes_1" title="Reverting changes" class="md-nav__link">
    Reverting changes
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/opensciencegrid/operations/edit/master/docs/services/topology.md" title="Edit this page" class="md-icon md-content__icon">&#xE3C9;</a>
                
                
                <h1 id="topology-service">Topology Service</h1>
<p>This document contains information about the service that runs <a href="https://topology.opensciencegrid.org">https://topology.opensciencegrid.org</a> and <a href="https://topology-itb.opensciencegrid.org">https://topology-itb.opensciencegrid.org</a>.
(These sites are also accessible as <a href="https://my.opensciencegrid.org">https://my.opensciencegrid.org</a> and <a href="https://my-itb.opensciencegrid.org">https://my-itb.opensciencegrid.org</a>.)</p>
<p>The source code for the service is in <a href="https://github.com/opensciencegrid/topology">https://github.com/opensciencegrid/topology</a>, in the <code>src/</code> subdirectory.
This repository also contains the public part of the data that gets served.</p>
<h2 id="deployment">Deployment</h2>
<p>Topology is a webapp run with Apache on the host <code>topology.opensciencegrid.org</code>.
The ITB instance runs on the host <code>topology-itb.opensciencegrid.org</code>.
The hosts are VMs at Nebraska;
for SSH access, contact Derek Weitzel or Brian Bockelman.</p>
<h3 id="installation">Installation</h3>
<p>These instructions assume an EL 7 host with the EPEL repositories available.
The software will be installed into <code>/opt/topology</code>.
A second instance for the webhook app will be installed into <code>/opt/topology-webhook</code>.
(The ITB instance should be installed into <code>/opt/topology-itb</code> and <code>/opt/topology-itb-webhook</code> instead.)
The following steps should be done as root.</p>
<ol>
<li>
<p>Install prerequisites:</p>
<div class="codehilite"><pre><span></span><span class="gp">#</span> yum install python36 gridsite httpd mod_ssl
</pre></div>


</li>
<li>
<p>Clone the repository:</p>
<p>For the production topology host:</p>
<div class="codehilite"><pre><span></span><span class="gp">#</span> git clone https://github.com/opensciencegrid/topology /opt/topology
<span class="gp">#</span> git clone https://github.com/opensciencegrid/topology /opt/topology-webhook
</pre></div>


<p>For the topology-itb host:</p>
<div class="codehilite"><pre><span></span><span class="gp">#</span> git clone https://github.com/opensciencegrid/topology /opt/topology-itb
<span class="gp">#</span> git clone https://github.com/opensciencegrid/topology /opt/topology-itb-webhook
</pre></div>


</li>
<li>
<p>Set up the virtualenv in the clone -- from <code>/opt/topology</code> or <code>/opt/topology-itb</code>:</p>
<div class="codehilite"><pre><span></span><span class="gp">#</span> python36 -m venv venv
<span class="gp">#</span> . ./venv/bin/activate
<span class="gp">#</span> pip install -r requirements.txt
</pre></div>


</li>
<li>
<p>Repeat for the webhook instance -- from <code>/opt/topology-webhook</code> or <code>/opt/topology-itb-webhook</code>.</p>
</li>
</ol>
<h3 id="file-system-locations">File system locations</h3>
<p>The following files/directories must exist and have the proper permissions:</p>
<table>
<thead>
<tr>
<th>Location</th>
<th>Purpose</th>
<th>Ownership</th>
<th>Mode</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>/opt/topology</code></td>
<td>Production software install</td>
<td>root:root</td>
<td>0755</td>
</tr>
<tr>
<td><code>/opt/topology-itb</code></td>
<td>ITB software install</td>
<td>root:root</td>
<td>0755</td>
</tr>
<tr>
<td><code>/opt/topology-webhook</code></td>
<td>Production webhook software install</td>
<td>root:root</td>
<td>0755</td>
</tr>
<tr>
<td><code>/opt/topology-itb-webhook</code></td>
<td>ITB webhook software install</td>
<td>root:root</td>
<td>0755</td>
</tr>
<tr>
<td><code>/etc/opt/topology/config-production.py</code></td>
<td>Production config</td>
<td>root:root</td>
<td>0644</td>
</tr>
<tr>
<td><code>/etc/opt/topology/config-itb.py</code></td>
<td>ITB config</td>
<td>root:root</td>
<td>0644</td>
</tr>
<tr>
<td><code>/etc/opt/topology/bitbucket</code></td>
<td>Private key for contact info repo</td>
<td>apache:root</td>
<td>0600</td>
</tr>
<tr>
<td><code>/etc/opt/topology/bitbucket.pub</code></td>
<td>Public key for contact info repo</td>
<td>apache:root</td>
<td>0644</td>
</tr>
<tr>
<td><code>/etc/opt/topology/github</code></td>
<td>Private key for pushing automerge commits</td>
<td>topomerge:root</td>
<td>0600</td>
</tr>
<tr>
<td><code>/etc/opt/topology/github.pub</code></td>
<td>Public key for pushing automerge commits</td>
<td>topomerge:root</td>
<td>0644</td>
</tr>
<tr>
<td><code>/etc/opt/topology/github_webhook_secret</code></td>
<td>GitHub webhook secret for validating webhooks</td>
<td>topomerge:root</td>
<td>0600</td>
</tr>
<tr>
<td><code>~apache/.ssh</code></td>
<td>SSH dir for Apache</td>
<td>apache:root</td>
<td>0700</td>
</tr>
<tr>
<td><code>~apache/.ssh/known_hosts</code></td>
<td>Known hosts file for Apache</td>
<td>apache:root</td>
<td>0644</td>
</tr>
<tr>
<td><code>~topomerge</code></td>
<td>Home dir for <code>topomerge</code> Apache user</td>
<td>topomerge:root</td>
<td>0755</td>
</tr>
<tr>
<td><code>~topomerge/.ssh</code></td>
<td>SSH dir for <code>topomerge</code> Apache user</td>
<td>topomerge:root</td>
<td>0700</td>
</tr>
<tr>
<td><code>~topomerge/.ssh/known_hosts</code></td>
<td>Known hosts file for <code>topomerge</code> Apache user</td>
<td>topomerge:root</td>
<td>0644</td>
</tr>
<tr>
<td><code>/var/cache/topology</code></td>
<td>Checkouts of topology and contacts data for production instance</td>
<td>apache:apache</td>
<td>0755</td>
</tr>
<tr>
<td><code>/var/cache/topology-itb</code></td>
<td>Checkouts of topology and contacts data for ITB instance</td>
<td>apache:apache</td>
<td>0755</td>
</tr>
<tr>
<td><code>/var/cache/topology-webhook</code></td>
<td>Topology repo and state info for production webhook instance</td>
<td>topomerge:topomerge</td>
<td>0755</td>
</tr>
<tr>
<td><code>/var/cache/topology-itb-webhook</code></td>
<td>Topology repo and state info for ITB webhook instance</td>
<td>topomerge:topomerge</td>
<td>0755</td>
</tr>
</tbody>
</table>
<p><code>~apache/.ssh/known_hosts</code> must contain an entry for <code>bitbucket.org</code>;
use <code>ssh-keyscan bitbucket.org</code> to get the appropriate entry.</p>
<p><code>~topomerge/.ssh/known_hosts</code> must contain an entry for <code>github.com</code>;
use <code>ssh-keyscan github.com</code> to get the appropriate entry.</p>
<h3 id="software-configuration">Software configuration</h3>
<p>Configuration for the main app is under <code>/etc/opt/topology/</code>, in <code>config-production.py</code> and <code>config-itb.py</code>.
The webhook app configuration is in <code>config-production-webhook.py</code> and <code>config-itb-webhook.py</code>.
The files are in Python format and override default settings in <code>src/webapp/default_config.py</code> in the topology repo.</p>
<p>HTTPD configuration is in <code>/etc/httpd</code>; we use the modules <code>mod_ssl</code>, <code>mod_gridsite</code>, and <code>mod_wsgi</code>.
The first two are installed via yum;
the .so file for mod_wsgi is located in <code>/opt/topology/venv/lib/python3.6/site-packages/mod_wsgi/server/</code>
or <code>/opt/topology-itb/venv/lib/python3.6/site-packages/mod_wsgi/server/</code> for the ITB instance.</p>
<p><strong>TODO Derek can you write something here?</strong></p>
<h3 id="data-configuration">Data configuration</h3>
<p>Configuration is in <code>/etc/opt/topology/config-production.py</code> and <code>config-itb.py</code>;
and <code>config-production-webhook.py</code> and <code>config-itb-webhook.py</code>.</p>
<table>
<thead>
<tr>
<th>Variable</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>TOPOLOGY_DATA_DIR</code></td>
<td>The directory containing a clone of the <code>topology</code> repository for data use</td>
</tr>
<tr>
<td><code>TOPOLOGY_DATA_REPO</code></td>
<td>The remote tracking repository of <code>TOPOLOGY_DATA_DIR</code></td>
</tr>
<tr>
<td><code>TOPOLOGY_DATA_BRANCH</code></td>
<td>The remote tracking branch of <code>TOPOLOGY_DATA_DIR</code></td>
</tr>
<tr>
<td><code>WEBHOOK_DATA_DIR</code></td>
<td>The directory containing a mirror-clone of the <code>topology</code> repository for webhook use</td>
</tr>
<tr>
<td><code>WEBHOOK_DATA_REPO</code></td>
<td>The remote tracking repository of <code>WEBHOOK_DATA_DIR</code></td>
</tr>
<tr>
<td><code>WEBHOOK_DATA_BRANCH</code></td>
<td>The remote tracking branch of <code>WEBHOOK_DATA_DIR</code></td>
</tr>
<tr>
<td><code>WEBHOOK_STATE_DIR</code></td>
<td>Directory containing webhook state information between pull request and status hooks</td>
</tr>
<tr>
<td><code>WEBHOOK_SECRET_KEY</code></td>
<td>Secret key configured on GitHub for webhook delivery</td>
</tr>
<tr>
<td><code>CONTACT_DATA_DIR</code></td>
<td>The directory containing a clone of the <code>contact</code> repository for data use</td>
</tr>
<tr>
<td><code>CONTACT_DATA_REPO</code></td>
<td>The remote tracking repository of <code>CONTACT_DATA_DIR</code></br>(default: <code>"git@bitbucket.org:opensciencegrid/contact.git"</code>)</td>
</tr>
<tr>
<td><code>CONTACT_DATA_BRANCH</code></td>
<td>The remote tracking branch of <code>CONTACT_DATA_BRANCH</code></br>(default: <code>"master"</code>)</td>
</tr>
<tr>
<td><code>CACHE_LIFETIME</code></td>
<td>Frequency of automatic data updates in seconds</br>(default: <code>900</code>)</td>
</tr>
<tr>
<td><code>GIT_SSH_KEY</code></td>
<td>Location of ssh public key file for git access.<br/></td>
</tr>
<tr>
<td><code>/etc/opt/topology/bitbucket.pub</code> for the main app, and <code>/etc/opt/topology/github.pub</code> for the webhook app</td>
<td></td>
</tr>
</tbody>
</table>
<p>Puppet ensures that the production <code>contact</code> and <code>topology</code> clones are up to date with their configured remote tracking
repo and branch.
Puppet does not manage the ITB data directories so they need to be updated by hand during testing.</p>
<h3 id="github-configuration-for-webhook-app">GitHub Configuration for Webhook App</h3>
<ol>
<li>
<p>Go to the <a href="https://github.com/opensciencegrid/topology/settings/hooks">webhook settings</a> page on GitHub.
     There are four webhooks to set up; <code>pull_request</code> and <code>status</code> for both the topology and topology-itb hosts.</p>
<table>
<thead>
<tr>
<th>Payload URL</th>
<th>Content type</th>
<th>Events to trigger webhook</th>
</tr>
</thead>
<tbody>
<tr>
<td>https://topology.opensciencegrid.org/webhook/status</td>
<td>application/json</td>
<td>Statuses</td>
</tr>
<tr>
<td>https://topology.opensciencegrid.org/webhook/pull_request</td>
<td>application/json</td>
<td>Pull requests</td>
</tr>
<tr>
<td>https://topology-itb.opensciencegrid.org/webhook/status</td>
<td>application/json</td>
<td>Statuses</td>
</tr>
<tr>
<td>https://topology-itb.opensciencegrid.org/webhook/pull_request</td>
<td>application/json</td>
<td>Pull requests</td>
</tr>
</tbody>
</table>
<p>For each webhook, "Secret" should be a random 40 digit hex string, which should match the contents of the file
 <code>/etc/opt/topology/github_webhook_secret</code> (the path configured in <code>WEBHOOK_SECRET_KEY</code>).</p>
</li>
<li>
<p>The OSG's dedicated GitHub user for automating pushes is currently <a href="https://github.com/osg-bot">osg-bot</a>.</p>
<ol>
<li>
<p>This user needs to have write access to the <a href="https://github.com/opensciencegrid/topology">topology</a> repo on GitHub.</p>
</li>
<li>
<p>The ssh public key in <code>/etc/opt/topology/github.pub</code> should be registered with the <code>osg-bot</code> GitHub user.</p>
<p>This can be done by logging into GitHub as <code>osg-bot</code>, and adding the new ssh key under the
 <a href="https://github.com/settings/keys">settings</a> page.</p>
</li>
</ol>
</li>
</ol>
<h3 id="required-system-packages">Required System Packages</h3>
<p>Currently the webhook app uses the <code>mailx</code> command to send email.
If not already installed, install it with:</p>
<div class="codehilite"><pre><span></span>    :::console
    # yum install mailx
</pre></div>


<h2 id="testing-changes-on-the-itb-instance">Testing changes on the ITB instance</h2>
<p>All changes should be tested on the ITB instance before deploying to production.
If you can, test them on your local machine first.
These instructions assume that the code has not been merged to master.</p>
<ol>
<li>
<p>Update the ITB software installation at <code>/opt/topology-itb</code> and note the current branch:</p>
<div class="codehilite"><pre><span></span><span class="gp">#</span> <span class="nb">cd</span> /opt/topology-itb
<span class="gp">#</span> git fetch --all
<span class="gp">#</span> git status
</pre></div>


</li>
<li>
<p>Check out the branch you are testing.
    If the target remote is not configured, <a href="https://help.github.com/articles/adding-a-remote/">add it</a>:</p>
<div class="codehilite"><pre><span></span><span class="gp">#</span> git checkout -b &lt;BRANCH&gt; &lt;REMOTE&gt;/&lt;BRANCH NAME&gt;
</pre></div>


</li>
<li>
<p>Verify that you are using the intended data associated with the code you are testing:</p>
<ol>
<li>
<p>If the data format has changed in an incompatible way, modify <code>/etc/opt/topology/config-itb.py</code>:</p>
<ol>
<li>
<p>Backup the ITB configuration file:</p>
<div class="codehilite"><pre><span></span><span class="gp">#</span> <span class="nb">cd</span> /etc/opt/topology
<span class="gp">#</span> cp -p config-itb.py<span class="o">{</span>,.bak<span class="o">}</span>
</pre></div>


</li>
<li>
<p>Change the <code>TOPOLOGY_DATA_DIR</code> and/or <code>CONTACT_DATA_DIR</code> lines to point to a new directories so the previous
   data does not get overwritten with incompatible data.</p>
</li>
</ol>
</li>
<li>
<p>If you need to use a different branch for the data, switch to it:</p>
<ol>
<li>
<p>Check the branch of <code>TOPOLOGY_DATA_DIR</code> from  <code>/etc/opt/topology/config-itb.py</code></p>
<div class="codehilite"><pre><span></span><span class="gp">#</span> <span class="nb">cd</span> &lt;TOPOLOGY_DATA_DIR&gt;
<span class="gp">#</span> git fetch --all
<span class="gp">#</span> git status
</pre></div>


</li>
<li>
<p>Note the previous branch, you will need this later</p>
</li>
<li>If the target remote is not configured, <a href="https://help.github.com/articles/adding-a-remote/">add it</a></li>
<li>Check out the target branch:<div class="codehilite"><pre><span></span><span class="gp">#</span> git checkout -b &lt;BRANCH NAME&gt; &lt;REMOTE&gt;/&lt;BRANCH NAME&gt;
</pre></div>


</li>
</ol>
</li>
<li>
<p>Pull any upstream changes to ensure that your branch is up to date:</p>
<div class="codehilite"><pre><span></span><span class="gp">#</span> git pull
</pre></div>


</li>
</ol>
</li>
<li>
<p>For updates to the webhook app, follow the above instructions for the ITB webhook instance under
<code>/opt/topology-itb-webhook</code> and its corresponding config file, <code>/etc/opt/topology/config-itb-webhook.py</code>.</p>
</li>
<li>
<p>Restart <code>httpd</code>:</p>
<div class="codehilite"><pre><span></span><span class="gp">#</span> systemctl restart httpd
</pre></div>


</li>
<li>
<p>Test the web interface at <a href="https://topology-itb.opensciencegrid.org">https://topology-itb.opensciencegrid.org</a>.</p>
<p>Errors and output are in <code>/var/log/httpd/error_log</code>.</p>
</li>
</ol>
<h3 id="reverting-changes">Reverting changes</h3>
<ol>
<li>
<p>Switch <code>/opt/topology-itb</code> to the previous branch:</p>
<div class="codehilite"><pre><span></span><span class="gp">#</span> <span class="nb">cd</span> /opt/topology-itb
<span class="gp">#</span> git checkout &lt;BRANCH&gt;
</pre></div>


</li>
<li>
<p>For updates to the webhook app, switch <code>/opt/topology-itb-webhook</code> to the previous master:</p>
<div class="codehilite"><pre><span></span><span class="gp">#</span> <span class="nb">cd</span> /opt/topology-itb-webhook
<span class="gp">#</span> git checkout &lt;BRANCH&gt;
</pre></div>


</li>
<li>
<p>If you made config changes to <code>/etc/opt/topology/config-itb.py</code> or <code>config-itb-webhook.py</code>, restore the backup.</p>
</li>
<li>
<p>If you checked out a different branch for data, revert it back to the old branch.</p>
</li>
<li>
<p>Restart <code>httpd</code>:</p>
<div class="codehilite"><pre><span></span><span class="gp">#</span> systemctl restart httpd
</pre></div>


</li>
<li>
<p>Test the web interface at <a href="https://topology-itb.opensciencegrid.org">https://topology-itb.opensciencegrid.org</a>.</p>
</li>
</ol>
<h2 id="updating-the-production-instance">Updating the production instance</h2>
<p>Updating the production instance is similar to updating ITB instance.</p>
<ol>
<li>
<p>Update master on the Git clone at <code>/opt/topology</code>:</p>
<div class="codehilite"><pre><span></span><span class="gp">#</span> <span class="nb">cd</span> /opt/topology
<span class="gp">#</span> git pull origin master
</pre></div>


</li>
<li>
<p>For updates to the webhook app, update master on the Git clone at <code>/opt/topology-webhook</code>:</p>
<div class="codehilite"><pre><span></span># cd /opt/topology-webhook
# git pull origin master
</pre></div>


</li>
<li>
<p>Make config changes to <code>/etc/opt/topology/config-production.py</code> and/or <code>config-production-webhook.py</code> if necessary.</p>
</li>
<li>
<p>Restart <code>httpd</code>:</p>
<div class="codehilite"><pre><span></span><span class="gp">#</span> systemctl restart httpd
</pre></div>


</li>
<li>
<p>Test the web interface at <a href="https://topology.opensciencegrid.org">https://topology.opensciencegrid.org</a>.</p>
<p>Errors and output are in <code>/var/log/httpd/error_log</code>.</p>
</li>
</ol>
<h3 id="reverting-changes_1">Reverting changes</h3>
<ol>
<li>
<p>Switch <code>/opt/topology</code> to the previous master:</p>
<div class="codehilite"><pre><span></span><span class="gp">#</span> <span class="nb">cd</span> /opt/topology
<span class="gp">#</span><span class="c1">## (use `git reflog` to find the previous commit that was used)</span>
<span class="gp">#</span> git reset --hard &lt;COMMIT&gt;
</pre></div>


</li>
<li>
<p>For updates to the webhook app, switch <code>/opt/topology-webhook</code> to the previous master:</p>
<div class="codehilite"><pre><span></span># cd /opt/topology-webhook
### (use `git reflog` to find the previous commit that was used)
# git reset --hard &lt;COMMIT&gt;
</pre></div>


</li>
<li>
<p>If you made config changes to <code>/etc/opt/topology/config-production.py</code> or <code>config-production-webhook.py</code>, revert them.</p>
</li>
<li>
<p>Restart <code>httpd</code>:</p>
<div class="codehilite"><pre><span></span><span class="gp">#</span> systemctl restart httpd
</pre></div>


</li>
<li>
<p>Test the web interface at <a href="https://topology.opensciencegrid.org">https://topology.opensciencegrid.org</a>.</p>
</li>
</ol>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../install-gwms-factory/" title="Installing GlideinWMS Factory" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Installing GlideinWMS Factory
              </span>
            </div>
          </a>
        
        
          <a href="../topology-contacts-data/" title="Topology and Contacts Data" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Topology and Contacts Data
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        powered by
        <a href="https://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
        
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../assets/javascripts/application.30f6b8b1.js"></script>
      
      <script>app.initialize({version:"0.17.5",url:{base:"../.."}})</script>
      
    
    
      
        <script>!function(e,a,t,n,o,c,i){e.GoogleAnalyticsObject=o,e.ga=e.ga||function(){(e.ga.q=e.ga.q||[]).push(arguments)},e.ga.l=1*new Date,c=a.createElement(t),i=a.getElementsByTagName(t)[0],c.async=1,c.src="https://www.google-analytics.com/analytics.js",i.parentNode.insertBefore(c,i)}(window,document,"script",0,"ga"),ga("create","UA-69012-29","opensciencegrid.github.io"),ga("set","anonymizeIp",!0),ga("send","pageview");var links=document.getElementsByTagName("a");if(Array.prototype.map.call(links,function(e){e.host!=document.location.host&&e.addEventListener("click",function(){var a=e.getAttribute("data-md-action")||"follow";ga("send","event","outbound",a,e.href)})}),document.forms.search){var query=document.forms.search.query;query.addEventListener("blur",function(){if(this.value){var e=document.location.pathname;ga("send","pageview",e+"?q="+this.value)}})}</script>
      
    
  </body>
</html>